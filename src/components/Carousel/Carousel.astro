---
import type { CarouselProps } from './carousel'

import ConditionalWrapper from '../ConditionalWrapper/ConditionalWrapper.astro'
import Pagination from '../Pagination/Pagination.astro'
import Progress from '../Progress/Progress.astro'

import { classNames } from '../../utils/classNames'

import styles from './carousel.module.scss'

interface Props extends CarouselProps {}

const {
    items,
    itemsPerSlide = 1,
    subText,
    scrollSnap = true,
    progress,
    pagination,
    effect,
    debounce = 20,
    className,
    wrapperClassName,
    paginationClassName
} = Astro.props

const classes = [
    styles.carousel,
    className
]

const containerClasses = [
    styles.container,
    scrollSnap && styles.snap
]

const getItemsPerSlide = () => typeof itemsPerSlide === 'number'
    ? itemsPerSlide
    : itemsPerSlide.default || 1

const wrapperClasses = [
    styles.wrapper,
    effect && styles[effect],
    getItemsPerSlide() > 1 && styles['no-snap'],
    wrapperClassName
]

const paginationWrapperClasses = [
    styles['pagination-wrapper'],
    paginationClassName
]

const paginationClasses = classNames([
    styles.pagination,
    !subText && paginationClassName
])

const totalPages = Math.ceil(items / getItemsPerSlide())
const subTextValue = subText?.match(/\{0\}|\{1\}/g) ? subText : undefined
const style = getItemsPerSlide() > 1
    ? `--w-slide-width: calc(${100 / getItemsPerSlide()}% - 5px);`
    : null
---

<section class:list={classes}>
    <div
        class:list={containerClasses}
        data-id="w-carousel"
        data-debounce={debounce !== 20 && debounce}
    >
        <ul
            class:list={wrapperClasses}
            style={style}
            data-visible-items={getItemsPerSlide() > 1 ? getItemsPerSlide() : null}
            data-breakpoint-items={typeof itemsPerSlide !== 'number' ? JSON.stringify(itemsPerSlide) : null}
        >
            <slot />
        </ul>
    </div>
    <ConditionalWrapper condition={!!(subText || progress)}>
        <div slot="wrapper" class:list={paginationWrapperClasses}>children</div>
        {progress && (
            <Progress
                className="w-carousel-progress"
                value={0}
            />
        )}
        <Pagination
            type="arrows"
            {...pagination}
            totalPages={totalPages}
            className={paginationClasses}
        />
        {subText && (
            <span class={styles.subtext} data-text={subTextValue}>
                {subText
                    .replace('{0}', '1')
                    .replace('{1}', String(totalPages))
                }
            </span>
        )}
    </ConditionalWrapper>
</section>

<script>
    import { debounce } from '../../utils/debounce'
    import { listen } from '../../utils/event'
    import { getBreakpoint } from '../../utils/getBreakpoint'

    const addEventListeners = () => {
        const carousels = Array.from(document.querySelectorAll('[data-id="w-carousel"]'))

        const scroll = (event: Event) => {
            const target = event.target as HTMLDivElement

            if (!target.dataset.paginated) {
                const scrollLeft = target.scrollLeft
                const itemWidth = target.children[0].clientWidth
                const page = Math.round(scrollLeft / itemWidth) + 1
                const carouselElement = target.children[0]
                const paginationElement = target.parentElement
                    ?.querySelector('[data-id="w-pagination"]') as HTMLUListElement
                const currentPage = Number(paginationElement.dataset.currentPage)
                const diff = Math.abs(currentPage - page)

                let triggerButton = currentPage > page
                    ? paginationElement.querySelector('[data-page="prev"]') as HTMLButtonElement
                    : paginationElement.querySelector('[data-page="next"]') as HTMLButtonElement

                if (!triggerButton) {
                    triggerButton = paginationElement.querySelector(`[data-page="${page}"]`) as HTMLButtonElement
                }

                for (let i = 0; i < diff; i++) {
                    triggerButton?.click()
                }

                Array.from(carouselElement.children).forEach(li => {
                    (li as HTMLLIElement).removeAttribute('data-active')
                })

                const activeElement = carouselElement.children[page - 1] as HTMLLIElement

                activeElement.dataset.active = 'true'
            }
        }

        const updateOnResize = (entries: ResizeObserverEntry[]) => {
            const target = entries[0].target
            const carousel = target.querySelector<HTMLUListElement>('ul')
            const pagination = target.parentElement?.querySelector<HTMLUListElement>('[data-id="w-pagination"]')
            const breakpoint = getBreakpoint()

            if (!target || !carousel || !pagination) {
                return
            }

            if (carousel.dataset.currentBreakpoint === breakpoint) {
                return
            }

            const progress = target.parentElement?.querySelector<HTMLDivElement>('.w-carousel-progress')
            const prevPageButton = pagination.querySelector<HTMLButtonElement>('[data-page="prev"]')
            const nextPageButton = pagination.querySelector<HTMLButtonElement>('[data-page="next"]')
            const subText = pagination.nextElementSibling
            const breakpoints = JSON.parse(carousel.dataset.breakpointItems || '')
            const itemsPerSlide = breakpoints[breakpoint] || breakpoints.default
            const totalItems = carousel.children.length
            const totalPages = Math.ceil(totalItems / itemsPerSlide)

            carousel.dataset.currentBreakpoint = breakpoint
            carousel.dataset.visibleItems = itemsPerSlide
            carousel.children[0].scrollIntoView({ behavior: 'smooth', block: 'nearest' })
            carousel.style.setProperty('--w-slide-width', `calc(${100 / itemsPerSlide}% - 5px)`)

            pagination.dataset.totalPages = String(totalPages)

            if (!(prevPageButton && nextPageButton)) {
                pagination.innerHTML = Array.from({ length: totalPages }, (_, i) => i + 1)
                    .map(i => `
                        <li>
                            <button
                                data-active="${i - 1 === 0}"
                                data-page="${i}"
                                aria-label="${`page ${i}`}"
                            ></button>
                        </li>
                    `).join('')
            }

            if (progress && progress.children[0] instanceof HTMLDivElement) {
                progress.children[0].style.setProperty('--w-progress-width', '0%')
            }

            if (subText instanceof HTMLSpanElement && subText?.dataset.text) {
                subText.innerText = subText.dataset.text
                    .replace('{0}', '1')
                    .replace('{1}', String(totalPages))
            }
        }

        carousels.forEach(carousel => {
            const carouselElement = carousel as HTMLDivElement
            const carouselList = carousel.querySelector<HTMLUListElement>('ul')
            const observer = new ResizeObserver(updateOnResize)
            const debounceAmount = carouselElement.dataset.debounce
                ? Number(carouselElement.dataset.debounce)
                : 20

            if (carouselList?.dataset.breakpointItems) {
                observer.observe(carouselElement)
            }

            carousel.addEventListener('scroll', debounce((event: Event) => {
                scroll(event)
            }, debounceAmount))
        })
    }

    listen('paginate', event => {
        const target = event.target
        const carousel = target.closest('section').querySelector('[data-id="w-carousel"] ul')

        if (!carousel) {
            return
        }

        const progress = target.closest('section').querySelector('.w-carousel-progress')
        const progressValue = (100 / (Number(target.dataset.totalPages) - 1))
        const itemsPerSlide = Number(carousel.dataset.visibleItems) || 1
        const totalItems = carousel.children.length
        const indexes = Array.from({ length: Math.ceil(totalItems / itemsPerSlide) }, (_, i) => {
            return Array.from({ length: itemsPerSlide }, (_, j) => (i * itemsPerSlide) + j)
                .filter(index => index < totalItems)
        })

        if (indexes.length < event.page) {
            return
        }

        const pageIndex = event.direction === 'prev'
            ? indexes[event.page - 1][0]
            : indexes[event.page - 1][indexes[event.page - 1].length - 1]

        const liElement = carousel.children[pageIndex]
        const subText = event.target.parentElement.querySelector('span')

        Array.from(carousel.children).forEach(li => {
            (li as HTMLLIElement).removeAttribute('data-active')
        })

        if (subText?.dataset.text) {
            subText.innerText = subText.dataset.text
                .replace('{0}', event.page)
                .replace('{1}', target.dataset.totalPages)
        }

        if (progress) {
            const updatedProgress = progressValue * (Number(event.page) - 1)

            progress.children[0]
                .style.setProperty('--w-progress-width', `${updatedProgress}%`)
        }

        if (event.trusted) {
            const carouselContainer = target.closest('section').querySelector('[data-id="w-carousel"]')

            liElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' })
            liElement.dataset.active = 'true'

            carouselContainer.dataset.paginated = 'true'

            setTimeout(() => {
                carouselContainer.removeAttribute('data-paginated')
            }, 300)
        }
    })

    document.addEventListener('astro:after-swap', addEventListeners)
    addEventListeners()
</script>
